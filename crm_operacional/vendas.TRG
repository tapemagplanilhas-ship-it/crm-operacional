TYPE=TRIGGERS
triggers='CREATE DEFINER=`root`@`localhost` TRIGGER `trg_clientes_after_insert_vendas` AFTER INSERT ON `vendas` FOR EACH ROW BEGIN\n    UPDATE clientes\n    SET \n        ultima_venda = (\n            SELECT MAX(data_venda)\n            FROM vendas\n            WHERE cliente_id = NEW.cliente_id AND status = \'concluida\'\n        ),\n        total_gasto = (\n            SELECT COALESCE(SUM(valor), 0)\n            FROM vendas\n            WHERE cliente_id = NEW.cliente_id AND status = \'concluida\'\n        ),\n        media_gastos = (\n            SELECT COALESCE(AVG(valor), 0)\n            FROM vendas\n            WHERE cliente_id = NEW.cliente_id AND status = \'concluida\'\n        ),\n        taxa_fechamento = (\n            SELECT\n                CASE \n                    WHEN COUNT(*) = 0 THEN 0\n                    ELSE (SUM(status = \'concluida\') / COUNT(*)) * 100\n                END\n            FROM vendas\n            WHERE cliente_id = NEW.cliente_id\n        )\n    WHERE id = NEW.cliente_id;\nEND' 'CREATE DEFINER=`root`@`localhost` TRIGGER `trg_vendas_after_insert_comportamento` AFTER INSERT ON `vendas` FOR EACH ROW BEGIN\n  IF NEW.cliente_id IS NOT NULL AND NEW.cliente_id > 0 THEN\n    CALL atualizar_comportamento_clientes(NEW.cliente_id);\n  END IF;\nEND' 'CREATE DEFINER=`root`@`localhost` TRIGGER `trg_clientes_after_update_vendas` AFTER UPDATE ON `vendas` FOR EACH ROW BEGIN\n    IF OLD.cliente_id != NEW.cliente_id THEN\n        UPDATE clientes\n        SET \n            ultima_venda = (\n                SELECT MAX(data_venda)\n                FROM vendas\n                WHERE cliente_id = OLD.cliente_id AND status = \'concluida\'\n            ),\n            total_gasto = (\n                SELECT COALESCE(SUM(valor), 0)\n                FROM vendas\n                WHERE cliente_id = OLD.cliente_id AND status = \'concluida\'\n            ),\n            media_gastos = (\n                SELECT COALESCE(AVG(valor), 0)\n                FROM vendas\n                WHERE cliente_id = OLD.cliente_id AND status = \'concluida\'\n            ),\n            taxa_fechamento = (\n                SELECT\n                    CASE \n                        WHEN COUNT(*) = 0 THEN 0\n                        ELSE (SUM(status = \'concluida\') / COUNT(*)) * 100\n                    END\n                FROM vendas\n                WHERE cliente_id = OLD.cliente_id\n            )\n        WHERE id = OLD.cliente_id;\n    END IF;\n\n    UPDATE clientes\n    SET \n        ultima_venda = (\n            SELECT MAX(data_venda)\n            FROM vendas\n            WHERE cliente_id = NEW.cliente_id AND status = \'concluida\'\n        ),\n        total_gasto = (\n            SELECT COALESCE(SUM(valor), 0)\n            FROM vendas\n            WHERE cliente_id = NEW.cliente_id AND status = \'concluida\'\n        ),\n        media_gastos = (\n            SELECT COALESCE(AVG(valor), 0)\n            FROM vendas\n            WHERE cliente_id = NEW.cliente_id AND status = \'concluida\'\n        ),\n        taxa_fechamento = (\n            SELECT\n                CASE \n                    WHEN COUNT(*) = 0 THEN 0\n                    ELSE (SUM(status = \'concluida\') / COUNT(*)) * 100\n                END\n            FROM vendas\n            WHERE cliente_id = NEW.cliente_id\n        )\n    WHERE id = NEW.cliente_id;\nEND' 'CREATE DEFINER=`root`@`localhost` TRIGGER `trg_vendas_after_update_comportamento` AFTER UPDATE ON `vendas` FOR EACH ROW BEGIN\n  -- Recalcula pro cliente atual\n  IF NEW.cliente_id IS NOT NULL AND NEW.cliente_id > 0 THEN\n    CALL atualizar_comportamento_clientes(NEW.cliente_id);\n  END IF;\n\n  -- Se mudou o cliente_id, recalcula tamb√©m pro cliente antigo\n  IF OLD.cliente_id <> NEW.cliente_id AND OLD.cliente_id IS NOT NULL AND OLD.cliente_id > 0 THEN\n    CALL atualizar_comportamento_clientes(OLD.cliente_id);\n  END IF;\nEND' 'CREATE DEFINER=`root`@`localhost` TRIGGER `trg_clientes_after_delete_vendas` AFTER DELETE ON `vendas` FOR EACH ROW BEGIN\n    UPDATE clientes\n    SET \n        ultima_venda = (\n            SELECT MAX(data_venda)\n            FROM vendas\n            WHERE cliente_id = OLD.cliente_id AND status = \'concluida\'\n        ),\n        total_gasto = (\n            SELECT COALESCE(SUM(valor), 0)\n            FROM vendas\n            WHERE cliente_id = OLD.cliente_id AND status = \'concluida\'\n        ),\n        media_gastos = (\n            SELECT COALESCE(AVG(valor), 0)\n            FROM vendas\n            WHERE cliente_id = OLD.cliente_id AND status = \'concluida\'\n        ),\n        taxa_fechamento = (\n            SELECT\n                CASE \n                    WHEN COUNT(*) = 0 THEN 0\n                    ELSE (SUM(status = \'concluida\') / COUNT(*)) * 100\n                END\n            FROM vendas\n            WHERE cliente_id = OLD.cliente_id\n        )\n    WHERE id = OLD.cliente_id;\nEND' 'CREATE DEFINER=`root`@`localhost` TRIGGER `trg_vendas_after_delete_comportamento` AFTER DELETE ON `vendas` FOR EACH ROW BEGIN\n  CALL atualizar_comportamento_clientes(OLD.cliente_id);\nEND'
sql_modes=524288 524288 524288 524288 524288 524288
definers='root@localhost' 'root@localhost' 'root@localhost' 'root@localhost' 'root@localhost' 'root@localhost'
client_cs_names='utf8mb4' 'utf8mb4' 'utf8mb4' 'utf8mb4' 'utf8mb4' 'utf8mb4'
connection_cl_names='utf8mb4_general_ci' 'utf8mb4_general_ci' 'utf8mb4_general_ci' 'utf8mb4_general_ci' 'utf8mb4_general_ci' 'utf8mb4_general_ci'
db_cl_names='utf8mb4_general_ci' 'utf8mb4_general_ci' 'utf8mb4_general_ci' 'utf8mb4_general_ci' 'utf8mb4_general_ci' 'utf8mb4_general_ci'
created=1770723179147238 1770723179162760 1770723179152418 1770723179168038 1770723179142488 1770723179157363
